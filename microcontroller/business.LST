C51 COMPILER V9.00   BUSINESS                                                              05/15/2016 00:26:01 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE BUSINESS
OBJECT MODULE PLACED IN business.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE business.c ROM(COMPACT) BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include "user_sys.h"
   2          #include "uart.h"
   3          #include "business.h"
   4          #include <string.h>
   5          #include <stdio.h>
   6          #include <reg52.h>
   7          #include "phy.h"
   8          
   9          #define LOCKER_TIMER 7
  10          
  11          extern app_Event getApp;
  12          
  13          extern uint8 uartData[15];
  14          extern uint8 uartIndex;
  15          
  16          #if 0
              uint8 code table[]={0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90};
              sbit P2_0 = P2^0;
              sbit P2_1 = P2^1;
              sbit P2_2 = P2^2;
              sbit P2_3 = P2^3;
              #endif
  23          
  24          //uint8 code table[]={0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,0x7f,0x6f};//不带小数点的共阴数码管段值
  25          //uint8 code table[]={0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90};
  26          
  27          uint8 code table[]={0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90};
  28          sbit P2_0 = P2^0;
  29          sbit P2_1 = P2^1;
  30          sbit P2_2 = P2^2;
  31          sbit P2_3 = P2^3;
  32          
  33          
  34          sbit locker1 = P1^0;
  35          sbit locker2 = P1^1;
  36          sbit locker3 = P1^2;
  37          
  38          
  39          SEGMENT_DISPLAYER segmentDisplaysIndex = SEGMENT_DISPLAYER_1_ON;
  40          
  41          sbit lockerPin=P1^7;    //定义位选
  42          
  43          int timer;
  44          
  45          typedef enum{
  46                  LOCK,
  47                  UNLOCK
  48          }LOCKER_STATUS;
  49          
  50          typedef enum{
  51                  LOCKER1_STATUS_REPORT,
  52                  LOCKER2_STATUS_REPORT,
  53                  LOCKER3_STATUS_REPORT
  54          }LOCKER_STATUS_STEP;
  55          
C51 COMPILER V9.00   BUSINESS                                                              05/15/2016 00:26:01 PAGE 2   

  56          LOCKER_STATUS_STEP lockerStatusStep;
  57          
  58          
  59          
  60          LOCKER_STATUS lockerStatus = LOCK;
  61          
  62          xdata LOCKER_STATUS lockerStatus1 = LOCK;
  63          xdata LOCKER_STATUS lockerStatus2 = LOCK;
  64          xdata LOCKER_STATUS lockerStatus3 = LOCK;
  65          
  66          
  67          
  68          
  69          
  70          void userBusinessEventHandle()
  71          {
  72   1              uint8 i;
  73   1              for(i=0;i<EVENT_NUMBER;i++)
  74   1              {
  75   2                      if((getApp.eventEDable_t[i]==ENABLE)&&(getApp.eventResultFlag_t[i]==ENABLE)&&(getApp.eventDoCount_t[i]<g
             -etApp.eventSetCount_t[i]))
  76   2                      {
  77   3                              userSystemSetEventDone(i);
  78   3                              switch(getApp.eventId_t[i])
  79   3                              {
  80   4                                      case EVENT_UART_RECIVE:
  81   4                                      {
  82   5                                              dealLocker(uartData);
  83   5                                              uartDataClean();
  84   5                                              setEvent(EVENT_UART_RECIVE, ENABLE,20,1);
  85   5                                      }
  86   4                                      break;
  87   4                                      case EVENT_LOCKER_STATUS_RSP:
  88   4                                      {
  89   5                                              //reportLockerStatus();
  90   5                                              setEvent(EVENT_LOCKER_STATUS_RSP, ENABLE,500,1);//定位
  91   5                                      }
  92   4                                      break;
  93   4                                      case EVENT_LOCKER1_UNLOCKED:
  94   4                                              lockerStatus1 = UNLOCK;
  95   4                                              //uartSendStr("unlocker1\r\n");
  96   4                                              if(lockerStatus1 == LOCK)
  97   4                                                      uartSendStr("L1A\r\n");
  98   4                                              else
  99   4                                                      uartSendStr("L1B\r\n");                 
 100   4                                              locker1 = 1;
 101   4                                      break;
 102   4                                      case EVENT_LOCKER2_UNLOCKED:
 103   4                                              lockerStatus2 = UNLOCK;                                 
 104   4                                              //uartSendStr("unlocker2\r\n");
 105   4                                              if(lockerStatus2 == LOCK)
 106   4                                                      uartSendStr("L2A\r\n");
 107   4                                              else
 108   4                                                      uartSendStr("L2B\r\n");                 
 109   4                                              locker2 = 1;
 110   4                                      break;
 111   4                                      case EVENT_LOCKER3_UNLOCKED:
 112   4                                              lockerStatus3 = UNLOCK;
 113   4                                              //uartSendStr("unlocker3\r\n");
 114   4                                              if(lockerStatus3 == LOCK)
 115   4                                                      uartSendStr("L3A\r\n");
 116   4                                              else
C51 COMPILER V9.00   BUSINESS                                                              05/15/2016 00:26:01 PAGE 3   

 117   4                                                      uartSendStr("L3B\r\n");                 
 118   4                                              locker3 = 1;
 119   4                                      break;
 120   4                                      case EVENT_SEGMENT_DISPLAYER:
 121   4                                      {
 122   5                                              switch(segmentDisplaysIndex)
 123   5                                              {
 124   6                                                      case SEGMENT_DISPLAYER_1_ON:
 125   6                                                              P2_3 = 1;
 126   6                                                              P0=table[0];
 127   6                                                              P2_0 = 0;
 128   6                                                              segmentDisplaysIndex = SEGMENT_DISPLAYER_2_ON;
 129   6                                                      break;
 130   6      
 131   6                                                      case SEGMENT_DISPLAYER_2_ON:
 132   6                                                              P2_0 = 1;
 133   6                                                              P0=table[1];
 134   6                                                              P2_1 = 0;
 135   6                                                              segmentDisplaysIndex = SEGMENT_DISPLAYER_3_ON;
 136   6                                                      break;
 137   6                                                      case SEGMENT_DISPLAYER_3_ON:
 138   6                                                              P2_1 = 1;
 139   6                                                              P0=table[2];
 140   6                                                              P2_2 = 0;
 141   6                                                              segmentDisplaysIndex = SEGMENT_DISPLAYER_4_ON;
 142   6                                                      break;
 143   6                                                      case SEGMENT_DISPLAYER_4_ON:
 144   6                                                              P2_2 = 1;
 145   6                                                              P0=table[3];
 146   6                                                              P2_3 = 0;
 147   6                                                              segmentDisplaysIndex = SEGMENT_DISPLAYER_1_ON;
 148   6                                                      break;          
 149   6                                              }
 150   5                                              setEvent(EVENT_SEGMENT_DISPLAYER, ENABLE,1,1);
 151   5                                      }
 152   4                                              //uartSendStr("EVENT_SEGMENT_DISPLAYER\r\n");
 153   4                                              /*P0=table[i];
 154   4                                              P2_0 = 0;*/
 155   4                                              //dealSegmentDisplays();
 156   4                                              //setEvent(EVENT_SEGMENT_DISPLAYER, ENABLE,1,1);
 157   4                                              break;
 158   4                                      default:
 159   4                                              break;
 160   4                              
 161   4                              }
 162   3                      }
 163   2                      else if((getApp.eventEDable_t[i]==ENABLE)&&(getApp.eventDoCount_t[i]>=getApp.eventSetCount_t[i]))
 164   2                      {
 165   3                              getApp.eventEDable_t[i]=DISABLE;
 166   3                      }
 167   2              }
 168   1      }
 169          
 170          void dealLocker(uint8 *cmd)
 171          {
 172   1              if(uartIndex < 2 ) return;
 173   1              if(uartIndex == 0) return;
 174   1      
 175   1              switch(cmd[0])
 176   1              {
 177   2                      case '1':
 178   2                      {
C51 COMPILER V9.00   BUSINESS                                                              05/15/2016 00:26:01 PAGE 4   

 179   3                              locker1 = 0;
 180   3                              //uartSendStr("open locker1 5s\r\n");
 181   3                              if(lockerStatus1 == LOCK)
 182   3                                      uartSendStr("L1A\r\n");
 183   3                              else
 184   3                                      uartSendStr("L1B\r\n");         
 185   3                              lockerStatus1 = LOCK;                   
 186   3                              setEvent(EVENT_LOCKER1_UNLOCKED, ENABLE,3000,1);
 187   3                      }
 188   2                      break;
 189   2                      case '2':
 190   2                      {
 191   3                              locker2 = 0;                    
 192   3                              if(lockerStatus2 == LOCK)
 193   3                                      uartSendStr("L2A\r\n");
 194   3                              else
 195   3                                      uartSendStr("L2B\r\n");                                 
 196   3                              lockerStatus2 = LOCK;                   
 197   3                              //uartSendStr("open locker2 5s\r\n");
 198   3                              setEvent(EVENT_LOCKER2_UNLOCKED, ENABLE,3000,1);
 199   3                      }
 200   2                      break;
 201   2                      case '3':
 202   2                      {
 203   3                              locker3 = 0;
 204   3                              if(lockerStatus3 == LOCK)
 205   3                                      uartSendStr("L3A\r\n");
 206   3                              else
 207   3                                      uartSendStr("L3B\r\n");                 
 208   3                              lockerStatus3 = LOCK;                   
 209   3                              //uartSendStr("open locker3 5s\r\n");
 210   3                              setEvent(EVENT_LOCKER3_UNLOCKED, ENABLE,3000,1);                
 211   3                      }
 212   2                      break;
 213   2              }
 214   1      
 215   1      #if 0
                      
                      if((cmd[0] == 'U')&&(cmd[1] == 'N')&&cmd[2] == 'L'&&cmd[3] == 'O'&&cmd[4] == 'C'&&cmd[5] == 'K'){
                              lockerPin = 1;
                              timer = LOCKER_TIMER;
                              uartSendStr("open locker 5s\r\n");
                              lockerStatus = UNLOCK;
                              reportLockerStatus();
                              //setEvent(EVENT_LOCK_LOCKER, ENABLE,500,1);
                              setEvent(EVENT_LOCKER_DAOJISHI, ENABLE,1,1);
                      }
                      if((cmd[0] == 'T')&&(cmd[1] == 'O')&&cmd[2] == 'L'&&cmd[3] == 'O'&&cmd[4] == 'C'&&cmd[5] == 'K'){
              
                              timer = 0;
                              lockerStatus = LOCK;
                              reportLockerStatus();
                              setEvent(EVENT_LOCKER_LOCKED, ENABLE,1,1);
                              setEvent(EVENT_LOCKER_DAOJISHI, DISABLE,0,0);
                      }
              #endif  
 235   1      }
 236          void reportLockerStatus()
 237          {
 238   1              switch(lockerStatusStep)
 239   1              {
 240   2                      case LOCKER1_STATUS_REPORT:
C51 COMPILER V9.00   BUSINESS                                                              05/15/2016 00:26:01 PAGE 5   

 241   2                      {
 242   3                              lockerStatusStep = LOCKER2_STATUS_REPORT;
 243   3                              if(lockerStatus1 == LOCK)
 244   3                                      uartSendStr("L1A\r\n");
 245   3                              else
 246   3                                      uartSendStr("L1B\r\n");         
 247   3                      }
 248   2                      break;
 249   2                      case LOCKER2_STATUS_REPORT:
 250   2                      {
 251   3                              lockerStatusStep = LOCKER3_STATUS_REPORT;
 252   3                              if(lockerStatus2 == LOCK)
 253   3                                      uartSendStr("L2A\r\n");
 254   3                              else
 255   3                                      uartSendStr("L2B\r\n");         
 256   3                      }
 257   2                      break;
 258   2                      case LOCKER3_STATUS_REPORT:
 259   2                      {
 260   3                              lockerStatusStep = LOCKER1_STATUS_REPORT;
 261   3                              if(lockerStatus3 == LOCK)
 262   3                                      uartSendStr("L3A\r\n");
 263   3                              else
 264   3                                      uartSendStr("L3B\r\n");
 265   3                      }
 266   2                      break;
 267   2              }       
 268   1      }
 269          void lockerInit()
 270          {
 271   1              locker1 = 1;
 272   1              locker2 = 1;
 273   1              locker3 = 1;
 274   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    579    ----
   CONSTANT SIZE    =     46    ----
   XDATA SIZE       =      3    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      5       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
